---
title: "2022 Undergraduate Student Satisfaction Survey Results \\vspace{-2.9cm}" 
format:
  pdf:
    documentclass: article
    classoption: []
    fig-width: 8
    geometry:
      - top=25mm
      - bottom=20mm
      - left=15mm
      - right=15mm
      - textwidth=4.5in
    keep-md: true
    include-in-header:
      - text: |
          \usepackage{titling}
          \setlength{\droptitle}{-1.5in}
          \pretitle{\begin{center}
          \includegraphics[height=1in]{/Users/linlizhou/Documents/Rprojects/IR.png}\LARGE\\}
      - text: |
          \usepackage{fancyhdr}
          \addtolength{\headheight}{0.7cm}
    
          \pagestyle{fancy} 
          \fancyhead{}
          \fancyfoot{}
    
          \fancyhead[LO]{\includegraphics[height=1.3cm]{/Users/linlizhou/Documents/Rprojects/IR.png}}
          \fancyhead[RE]{\vspace{4mm}\textbf{AAC Courses Review}}
          \fancyfoot[C]{\thepage}
    
          \renewcommand{\headrulewidth}{0pt}
editor: visual
---
```{r libraries, include = FALSE}
source("/Users/linlizhou/Documents/Rprojects/IR-Projects/theme_source.R")
#change 
#format: 
#  pdf:
#to
#format:
#  docx:
#    reference-doc: /Users/linlizhou/Documents/Rprojects/IR-Projects/lasell.report.template.docx
#    prefer-html: true
```

```{r load.ugsatis22.quan}
ugsatis22.quan<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/Student Satisfaction Survey/2022-2023/working.xlsx")
#check:names(ugsatis22.quan)
```

```{r load.enroll22f}
enroll22f<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Registrar Reports/2022 Fall/Fall 2022 UG Backup Data Report.xlsx")
```

```{r sec.names}
#what are basic groupdiff cols
#names(ugsatis22.quan)#identify basic sections (that will be groupdiff vars for all df.sec) 
#found: df[1-3], demography(3); mutate degree/year from 2022fall backup/enrolled
gpvar.names<-names(cbind(ugsatis22.quan[1:3],ugsatis22.quan[78:ncol(ugsatis22.quan)]))#the first cols and the ending mutated cols

#how many sections: approach 1: simpler version
sec.names<-names(ugsatis22.quan)%>%str_extract("[a-z]+\\.")%>%as_tibble()%>%filter(!value %in% c("demography.",NA))%>%unique()

#how many sections: approach 2 (so that number of item in each section can be calculated)
##sec.raw<-names(ugsatis22.quan)%>%str_extract("[a-z]+\\.")#extract any number (+) of noncapitalized letter ([a-z]), followed by a period (\\.)
##sec.names<-sec.raw[!sec.raw %in% c("demography.",NA)]%>%unique()#remove NA, identified basic sections, and duplications #check: length(sec.names) #12 sections

#how many items in each section
##for (i in 1:length(sec.names)){
##  itemnum[i]<-sec.raw[sec.raw%in%sec.names[i]]%>%length();i=i+1;itemnum}
##tibble(sec.names,itemnum)
#plan (logical and itemnum-sum): overall3+reenro5; crs7+advisor3; LASELL:service12; support8+edresource2; community12; social6+food3; timeopt 6+timehr7
```

# Response Rate

```{r show.viz_responserate, fig.height=2, include=TRUE}
#22 response rate: nrow(ugsatis22.quan)/nrow(enroll22f)
#15-21: 42,44,30,   22,35,50,36
viz_responserate<-tibble(year=c(2015,2016,2017,2018,2019,2020,2021,2022),
       resprate=c(.42,.44,.3,.22,.35,.5,.36,nrow(ugsatis22.quan)/nrow(enroll22f)))%>%
  ggplot(aes(x=year,y=resprate,group=1))+
  geom_line()+
  scale_color_manual(values = c(color_blue))+
  geom_text_repel(aes(label= if_else(year==2022,as.character(percent(resprate,digits=0)),"")),size=3, hjust=1,vjust=0, color="black",fontface="bold")+
  geom_text_repel(aes(label= if_else(!year==2022,as.character(percent(resprate,digits=0)),"")),size=3, hjust=-.5,vjust=0,color="grey40")+
  annotate("text",x=2022,y=.2,hjust=0.7,size=3,fontface="bold",label="(330 responses)")+
  labs(x="", y="")+ theme_lz()+theme(axis.text.x = element_text(vjust = -5))+
  scale_x_continuous(breaks=seq(2015, 2022, 1))
```

```{r show_viz_responserate,fig.height=1.5,include=TRUE}
#| label: fig-responserate
#| fig-cap: "Historical Response Rates to the Undergraduate Student Satisfaction Survey (2015-2022)"
viz_responserate
```

The survey response rate in 2022 is 26%,
which is close to the rate in pre-covid period in 2018.

# Student Characteristics

```{r gpvar.tbl_sample}
#recode so it shows as one group
ugsatis22.quan$rescom<-recode(ugsatis22.quan$rescom,`Online student`="Commuter student")

#construct a for loop
#initialize the output
gpvar.tbl<-tibble()
#each tbl bind to each other and output the mutated tbl
for (i in 1:length(gpvar.names)){
  #each newly constructed tbl
  gpvar.tbl_i<-
    #the basic tbl
  ugsatis22.quan%>%group_by(ugsatis22.quan[,gpvar.names[i]])%>%summarise(n=n())%>%
    #transform names and order/select the vars to show in tbl
  mutate(section=gpvar.names[i])%>%rename(type=gpvar.names[i])%>%
  filter(!is.na(type),!type%in%c("Not applicable","Prefer not to say","Prefer to self-describe (Please specify):","Trans/Non-Binary","Race and Ethnicity Unknown","	
CER","Native Hawaiian or Other Pacific Islander"))%>%mutate(prt=n/sum(n))%>%
  select(section,type,prt)
  #the next tbl
  i=i+1
  #mutate the new tbl to the initialized/previously-mutated tbl
  gpvar.tbl<-gpvar.tbl%>%rbind(gpvar.tbl_i)}
#check: unique(gpvar.tbl$section)

#remove unnecessary groupvars to show in table
gpvar.tbl_sample<-gpvar.tbl%>%
filter(!section%in%c("status","ppid","demography.sex","demography.gender","curriculum","cohort_id","college_attend"))%>%
  mutate(prt=percent(prt,digits=0))%>%rename(Sample=prt)

```

```{r gpvar.tbl_population}
#recode to match sample names 1
enroll22f.pop<-enroll22f%>%clean_names()%>%
  rename(rescom=res_comm)
#recode name 2
enroll22f.pop$rescom<-recode(enroll22f.pop$rescom,C="Commuter student",R="Residential student")  
# create matched name
gpvar.names_pop<-gpvar.names[gpvar.names %in% names(enroll22f.pop) ]
  
#construct a for loop
#initialize the output
gpvar.tblpop<-tibble()
#each tbl bind to each other and output the mutated tbl
for (i in 1:length(gpvar.names_pop)){
  #each newly constructed tbl
  gpvar.tblpop_i<-
    #the basic tbl
  enroll22f.pop%>%group_by(enroll22f.pop[,gpvar.names_pop[i]])%>%summarise(n=n())%>%
    #transform names and order/select the vars to show in tbl
  mutate(section=gpvar.names_pop[i])%>%rename(type=gpvar.names_pop[i])%>%
    filter(!is.na(type),!type%in%c("AA","CER","NON","Race and Ethnicity Unknown","Native Hawaiian or Other Pacific Islander"))%>%
    mutate(prt=n/sum(n))%>%select(section,type,prt)
  #the next tbl
  i=i+1
  #mutate the new tbl to the initialized/previously-mutated tbl
  gpvar.tblpop<-gpvar.tblpop%>%rbind(gpvar.tblpop_i)}


#remove unnecessary groupvars to show in table
gpvar.tbl_population<-gpvar.tblpop%>%filter(type %in% gpvar.tbl_sample$type)%>%select(type,prt)%>%mutate(prt=percent(prt,digits=0))%>%rename(Population=prt)
```

```{r tbl_samvspop}
#combine sample and pop tbl in one tbl
tbl_samvspop<-left_join(gpvar.tbl_sample,gpvar.tbl_population)%>%
  filter(!is.na(Population))# don't show sections that pop doesn't have

#recode for better viewability in tbl
tbl_samvspop$type<-recode(tbl_samvspop$type,
Y="Transfer",N="Not-transfer",FT="Full-time",PT="Part-time",
FR="1st-year",JR="3rd-year",SO="2nd-year",SR="4th-year",
`Commuter student`="Commuter",`Residential student`="Resident",
`M`="Male",`F`="Female",
`Black or African American`="Black",`Non Resident Alien`="International",
`Two or more Races`="Multi-races")
#order section
tbl_samvspop$section<-factor(tbl_samvspop$section,levels=c("gender","ethnicity","degree","class_level","ft_pt","transfer_yn","rescom"))

tbl_samvspop<-tbl_samvspop%>%arrange(section,-Sample,type)%>%
  #mutate(tblnum=case_when(section%in%c("demography.gender","ethnicity")~"1.personal",
  #       section%in%c("degree","class_level")~"2.university",
  #       section%in%c("ft_pt","transfer_yn","rescom")~"3.concentrate"))%>%
  mutate(Difference=percent(Sample-Population,digits = 1))%>%
  select(type,Sample,Population,Difference)

#order type
tbl_samvspop$type<-factor(tbl_samvspop$type,levels = c("Female","Male",
 "White","Hispanic","Black","Asian","Multi-races","International","BS","BA","1st-year","2nd-year","3rd-year","4th-year",
 "Full-time","Part-time","Not-transfer","Transfer","Resident","Commuter" ))
#apply the factor order to the table using arrange
tbl_samvspop<-tbl_samvspop%>%arrange(type)
  
```

```{r viz.tbl_samvspop}
viz.tbl_samvspop<-tbl_samvspop%>%#format table as viz
kbl(align = "c",booktabs = T,col.names =c("",str_wrap(names(tbl_samvspop)[2:ncol(tbl_samvspop)],width = 5))) %>%#label="tab.(a)", caption = "(a)subtablecaption",
#set in-text reference label, table title , header names
kable_styling(latex_options = c('HOLD_position'), full_width = F, fixed_thead = T, font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
#set overall style
column_spec(1, bold = T, border_right = F, background = "white", width = "8em",color="black")

#conditional formatting set up: 
cut1=.5;cut2=.3;cut3=.1;cut4=.0
for (i in 2:ncol(tbl_samvspop)){viz.tbl_samvspop<-column_spec(kable_input=viz.tbl_samvspop,column=i, width = "5em",color="white", background =cf_color_blue_abs(tbl_samvspop[i],a=cut1,b=cut2,c=cut3,d=cut4)); i=i+1;viz.tbl_samvspop}
```

```{r show_viz.tbl_samvspop,include=TRUE}
#| label: tbl-samvspop
#| tbl-cap: "Student Characteristics in Sample (Survey Respondents) and Population (All Undergraduate Students)"
viz.tbl_samvspop
```

@tbl-samvspop shows most students characteristics in sample and
population are similar. The only significant difference is around gender, where the survey responses has a 10%
over-representation of female students.


# How Students Spend Their Time
```{r ugsatis22.timeopt}
#create a new col for on/offcampus job
ugsatis22.quan.time<-ugsatis22.quan%>%
  mutate(timeopt.onoroffcampusjob=if_else(timeopt.oncampusjob=="Hours:"|timeopt.offcampusjob=="Hours:","Hours:","I don't know or not applicable"),
         timehr.onoroffcampusjob=timehr.oncampusjob+timehr.offcampusjob)#check:ugsatis22.quan.time%>%count(timeopt.onoroffcampusjob,timeopt.oncampusjob,timeopt.offcampusjob)

#create sleep8hr var
ugsatis22.quan.time<-ugsatis22.quan.time%>%
  mutate(timeopt.sleep8hr=if_else(
  timehr.sleep>=8,"Hours:","I don't know or not applicable"))#check:ugsatis22.quan.time%>%count(timeopt.sleep8hr,timehr.sleep)

#set once for all
prefix<-"timeopt."
#check same answers: lapply(ugsatis22.quan.time%>%select(starts_with(prefix)), unique)
#pivotlonger: one represent the categories, the other the answer values
ugsatis22.timeopt<-ugsatis22.quan.time%>%
  select(starts_with(prefix))%>%#check: str()
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))#check:ugsatis22.timeopt%>%count(timeopt.,timeopt.value)%>%View()
```

```{r viz_timeopt-hide}
#tbl for usage
viz_timeopt<-ugsatis22.timeopt%>%
  group_by(timeopt.,timeopt.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(timeopt.value=="Hours:")%>%
#viz
ggplot(aes(y=reorder(timeopt.,prt),x = prt, fill=timeopt.value)) + 
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
  scale_fill_manual(values = c(color_blue))+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("Intercollegiate Athletics","Volunteer","Sleep >8hr/day","On-campus Job","Off-campus Job","Club/Sports","Working (on/off campus)","Study (after class)"))+#1st label at bottom
  geom_text(aes(label=percent(prt,digits = 0)),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    xlim(0,.8)+labs(title="Students' Activity Involvement in 2022 Fall",x="",y="",fill="")+theme_lz()+theme(axis.text.y = element_text(),legend.position = "")
```


```{r viz_timeopt_satis.his}

#set order for showing timeopt. in good order in the historical usage tables
setyorder.timeopt<-ugsatis22.timeopt%>%
  group_by(timeopt.,timeopt.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(timeopt.value=="Hours:")%>%
  arrange(-prt)%>%mutate(yorder=factor(timeopt.))

#load historical timeopt_satis.prt
timeopt_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
timeopt.oncampusjob=c(0.21,0.13,0.29),
timeopt.offcampusjob=c(0.30,0.31,0.39),
timeopt.onoroffcampusjob=c(0.45,0.41,0.57),
timeopt.study=c(0.70,0.70,0.88),
timeopt.volunteer=c(0.11,0.08,0.2),
timeopt.club=c(0.32,0.23,0.43),
timeopt.sleep8hr=c(NA,0.32,0.29),
timeopt.athletics=c(0.12,0.12,0.2))%>%
  pivot_longer(cols=-c(year),names_to="timeopt.",values_to="prt")%>%select(timeopt.,prt,year)

#merge 2022 timeopt_satis prt
viz_timeopt_satis.his<-ugsatis22.timeopt%>%
  group_by(timeopt.,timeopt.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(timeopt.value=="Hours:")%>%mutate(year="2022")%>%
  select(timeopt.,prt,year)%>%
  rbind(timeopt_satis.his)%>%arrange(timeopt.,year,prt)%>%#View()
#viz
  ggplot(aes(y=prt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Involvement in Different Activities",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "")+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,1.3)+coord_flip()+
  
  facet_wrap(~factor(timeopt., levels = setyorder.timeopt$yorder,
                     labels=c("Study (after class)","Working (on/off campus)","Club/Sports","Off-campus Job","On-campus Job","Sleep >8hr/day","Volunteer","Intercollegiate Athletics")
                     ),
             ncol=1, strip.position="left") +
  geom_line(aes(y = prt, x=year, group=timeopt.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```


```{r ugsatis22.timehr}
#set once for all from sec.names$value
prefix<-"timehr."
#check same answers: lapply(ugsatis22.quan.time%>%select(starts_with(prefix)), unique)

#pivotlonger: one represent the categories, the other the answer values
ugsatis22.timehr<-ugsatis22.quan.time%>%
  select(starts_with(prefix))%>%#check: str()
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))#check:ugsatis22.timehr%>%count(timehr.)
#check outlier: arrange(ugsatis22.timehr,-timehr.value)%>%unique()
```

```{r viz_timehr-hide}
#tbl: first remove NA and unreasonable hr for 7 days
viz_timehr<-ugsatis22.timehr%>%filter(!is.na(timehr.value),timehr.value<80)%>%
  group_by(timehr.)%>%summarise(meanhr=round(mean(timehr.value),digits=0),medianhr=median(timehr.value))%>%
#viz
ggplot(aes(y=reorder(timehr.,meanhr),x = meanhr)) + 
  geom_bar(stat="identity",fill=color_blue,position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
   #no grp for value var then hide: scale_fill_manual(values = c())+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("Volunteer","Club/Sports","Sleep","On-campus Job","Intercollegiate Athletics","Study (after class)","Off-campus Job","Working"))+#1st label at bottom
  geom_text(aes(label=meanhr),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    xlim(0,22)+labs(title="Students' Mean Time of Activity Involvement in 2022 Fall",x="",y="",fill="")+theme_lz()+theme(axis.text.y = element_text(),legend.position = "")
```

```{r timehr_satis.his}
#load historical timehr_satis.meanhr
timehr_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
timehr.oncampusjob=c(9,10,10),
timehr.offcampusjob=c(19,18,17),
timehr.onoroffcampusjob=c(16.9,17.5,16),
timehr.study=c(12,14,14),
timehr.volunteer=c(6,6,4),
timehr.club=c(6,4,5),
timehr.atheletics=c(13,7,11),
timehr.sleep=c(NA,7,7))%>%
  pivot_longer(cols=-c(year),names_to="timehr.",values_to="meanhr")%>%select(timehr.,meanhr,year)
#check: timehr_satis.his%>%View()
```


```{r viz_timehr_satis.his}
#set order for showing timehr. in good order in the historical usage tables
setyorder.timehr<-ugsatis22.timehr%>%filter(!is.na(timehr.value),timehr.value<80)%>%
  group_by(timehr.)%>%summarise(meanhr=round(mean(timehr.value),digits=0),medianhr=median(timehr.value))%>%
  arrange(-meanhr)%>%mutate(yorder=factor(timehr.))

#merge 2022 timehr_satis meanhr
viz_timehr_satis.his<-ugsatis22.timehr%>%filter(!is.na(timehr.value),timehr.value<80)%>%
  group_by(timehr.)%>%summarise(meanhr=round(mean(timehr.value),digits=0),medianhr=median(timehr.value))%>%mutate(year="2022")%>%
  select(timehr.,meanhr,year)%>%
  rbind(timehr_satis.his)%>%arrange(timehr.,year,meanhr)%>%
#viz
  ggplot(aes(y=meanhr, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Hours per Week Spent for Different Activities",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "right",legend.direction = "vertical")+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(round(meanhr,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(round(meanhr,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,23)+coord_flip()+
  
  facet_wrap(~factor(timehr., levels = setyorder.timehr$yorder,
                     labels=c("Working","Off-campus Job","Study (after class)","Intercollegiate Athletics","On-campus Job","Sleep (per day)","Club/Sports","Volunteer")),
             ncol=1, strip.position="left") +
  geom_line(aes(y = meanhr, x=year, group=timehr.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```



```{r show.viz_timehr,fig.height=5,include=TRUE}
gridExtra::grid.arrange(viz_timeopt_satis.his,viz_timehr_satis.his,nrow=1)
```

This year student spend more hours (i.e. 21 hours) working on or off campus than previous years. Accordingly, students spend fewer time volunteering. Although percentages of students engaging in different activities are similar across years, we have less students with 8 or more hours of sleep. 

# Students' Educational Resources

```{r names_resource}
names_resource<-c("reenroll.lor",
"demography.highschool",
"edresource.uselaptop",
"edresource.textbook")
#check: names_resource[!names_resource%in%names(ugsatis22.quan)]
```

```{r resource_satis.his}
#load historical
resource_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
reenroll.lor=c(0.7,0.67,0.67),#>2
demography.highschool=c(0.71,0.74,0.76),#mostly white
edresource.uselaptop=c(NA,0.92,0.97),#own
edresource.textbook=c(NA,NA,0.84))%>%#own
  pivot_longer(cols=-c(year),names_to="resource.",values_to="prt")%>%select(resource.,prt,year)
#check: timehr_satis.his%>%View()
```

```{r ugsatis22.resource}
#check same answers: lapply(ugsatis22.quan[names(ugsatis22.quan)%in%names_resource], unique)
#recode
#select relevant vars
ugsatis22.resource<-ugsatis22.quan[names(ugsatis22.quan)%in%names_resource]
#less or equal to 2 lor
ugsatis22.resource$reenroll.lor<-recode(ugsatis22.resource$reenroll.lor,`2`="Yes",`3`="Yes","4 or more"="Yes")
#own laptop
ugsatis22.resource$edresource.uselaptop<-recode(ugsatis22.resource$edresource.uselaptop,`I use my own computer/laptop`="Yes")
#own textbook
ugsatis22.resource$edresource.textbook<-recode(ugsatis22.resource$edresource.textbook,`I buy my own textbooks`="Yes")
#predominantly white and mostly white
ugsatis22.resource$demography.highschool<-recode(ugsatis22.resource$demography.highschool,`1`="Yes",`2`="Yes")
#check: lapply(ugsatis22.resource, unique)

#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.resource<-ugsatis22.resource%>%
  pivot_longer(cols=all_of(names_resource),names_to="resource.",values_to="resource.value")%>%
  filter(!is.na(resource.value),!resource.value%in%c("I don't use a textbook/are not required","Other - Write In (Required)","Not applicable"))

#check:ugsatis22.resource%>%count(resource.); ugsatis22.resource%>%count(resource.value)
```

```{r viz_resource_satis.his}
#set order for showing resgrp. in good order in the historical usage tables
setyorder.resource<-ugsatis22.resource%>%
  group_by(resource.,resource.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(resource.value=="Yes")%>%arrange(-prt)%>%mutate(yorder=factor(resource.))

#merge 2022 resource_satis prt
viz_resource_satis.his<-ugsatis22.resource%>%
  group_by(resource.,resource.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(resource.value=="Yes")%>%mutate(year="2022")%>%
  select(resource.,prt,year)%>%
  rbind(resource_satis.his)%>%arrange(resource.,year,prt)%>%
#viz
  ggplot(aes(y=prt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue))+
  labs(title="",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "top",legend.margin = margin(t=10))+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=-.5,hjust=0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=-.5,hjust=0.5,position = position_dodge(0.9))+
  ylim(0,1.3)+
  
  facet_wrap(~factor(resource., levels = setyorder.resource$yorder, labels=c("Own a laptop","Own textbooks","High school mostly white","2 or more LOR")
                     ),
             nrow=1, strip.position="bottom") +
  geom_line(aes(y = prt, x=year, group=resource.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```


```{r show.viz_resource_satis.his,fig.height=1.8,include=TRUE}
viz_resource_satis.his
```

Similar percentage are found for students resources (i.e. owning laptops, textbooks, and letter of recommendations) and high school racial background.



# Overall Satisfaction

```{r ugsatis22.overall}
#check same answers: lapply(ugsatis22.quan%>%select(starts_with(sec.names$value[1])), unique)
#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.overall<-ugsatis22.quan%>%
  select(starts_with(sec.names$value[1]))%>%#check: str()
  pivot_longer(cols=starts_with(sec.names$value[1]),names_to=sec.names$value[1],values_to=paste0(sec.names$value[1],"value"))#check:%>%str()
#factorize
ugsatis22.overall<-ugsatis22.overall%>%
  mutate(overall.value=factor(overall.value,levels=c("Poor","Acceptable","Good","Excellent")))
```

```{r viz_overall22-hide}
#set the right order of values
setyorder.ov<-ugsatis22.overall%>%
  filter(!is.na(overall.value))%>%
  group_by(overall.,overall.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(overall.value=="Excellent")%>%arrange(prt)%>%mutate(yorder=factor(overall.))

#tbl
viz_overall22<-ugsatis22.overall%>%
  filter(!is.na(overall.value))%>%
  group_by(overall.,overall.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
#viz
ggplot(aes(y=factor(overall., levels = setyorder.ov$yorder, ordered = TRUE),
           x = prt, fill=overall.value)) + 
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
  scale_fill_manual(values = c("grey",color_bluelight,color_blue,color_blue_lasell))+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("Service","Facility","Experience"))+#1st label at bottom
  geom_text(aes(label=if_else(prt>0.03,as.character(percent(prt,digits = 0)),"")),#do not show anything less than error terms, to avoid overlapping labels as well
                     size=3,vjust=0,hjust=0.5,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    labs(title="Overall Satisfaction in 2022 Fall",x="",y="",fill="")+theme_lz()+theme(axis.text.x = element_text(),legend.position = "bottom",legend.margin=margin(t=-15))+coord_flip()
```

```{r viz_overall.hist}
#load historical overall.prt
overall.his<-tibble(overall.=c("overall.facility","overall.services","overall.exp"),
       `2018`=c(.72,.68,.75),
       `2019`=c(.69,.71,.76),
       `2020`=c(.73,.72,.72),
       `2021`=c(.63,.67,.71))%>%
  pivot_longer(cols=c(`2018`:`2021`),names_to="year",values_to="prt.pos")

#merge 2022 overall prt
viz_overall.hist<-ugsatis22.overall%>%filter(!is.na(overall.value))%>%
  group_by(overall.,overall.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(overall.value%in%c("Good","Excellent"))%>%ungroup()%>%
  group_by(overall.)%>%mutate(prt.pos=sum(prt))%>%
  ungroup()%>%select(overall.,prt.pos)%>%unique()%>%
  mutate(year="2022")%>%full_join(overall.his)%>%arrange(overall.,year)%>%
#viz
  ggplot(aes(y=prt.pos, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey65","grey75","grey80","grey90",color_blue))+
  labs(title="Overall Expereinces",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "top",legend.box.margin=margin(0,0,-20,0),legend.margin=margin(t=5))+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(prt.pos,digits = 0)),"")),size=3,vjust=-.5,hjust=0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(prt.pos,digits = 0)),"")),size=3,vjust=-.5,hjust=0.5,position = position_dodge(0.9))+
  ylim(0,1.2)+
  
  facet_wrap(~factor(overall., levels = setyorder.ov$yorder,labels=c("Facility","Service","Experience")),
             nrow=1, strip.position="bottom") +
  geom_line(aes(y = prt.pos, x=year, group=overall.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```


```{r ugsatis22.reenroll}
#set once for all from sec.names$value
prefix<-"reenroll."
#check same answers: lapply(ugsatis22.quan%>%select(starts_with(prefix)), unique)
#recode
ugsatis22.quan$reenroll.metexpect<-recode(ugsatis22.quan$reenroll.metexpect,
      `Worse than I expected`="No",
      `Much worse than I expected`="No",
      `Better than I expected`="Yes",
      `Much better than I expected`="Yes")
ugsatis22.quan$reenroll.reenroll<-recode(ugsatis22.quan$reenroll.reenroll,
      `Probably not`="No",
      `Definitely not`="No",
      `Probably`="Yes",
      `Definitely`="Yes")
ugsatis22.quan$reenroll.alumevent<-recode(ugsatis22.quan$reenroll.alumevent,
      `Probably not`="No",
      `Definitely not`="No",
      `Probably`="Yes",
      `Definitely`="Yes")
#new grp
grpyn.names<-c("reenroll.metexpect","reenroll.reenroll","reenroll.alumevent")

#pivotlonger: one represent the categories, the other the answer values
ugsatis22.reenroll<-ugsatis22.quan%>%
  select(starts_with(grpyn.names))%>%#check: str()
  pivot_longer(cols=starts_with(grpyn.names),names_to="reenroll.",values_to=paste0("reenroll.","value"))#check:ugsatis22.reenroll%>%str()
```

```{r viz_reenroll-hide}
#tbl: first remove NA from counting

viz_reenroll<-ugsatis22.reenroll%>%filter(!is.na(reenroll.value))%>%
  group_by(reenroll.,reenroll.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(reenroll.value=="Yes")%>%
#viz
ggplot(aes(y=reorder(reenroll.,prt),x = prt)) + 
  geom_bar(stat="identity",fill=color_blue,position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
   #no grp for value var then hide: scale_fill_manual(values = c())+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("Alumni Events","Reenroll","Meet Expectation"))+#1st label at bottom
  geom_text(aes(label=percent(prt,digits = 0)),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    xlim(0,.9)+labs(title="Overall Engagement",x="",y="",fill="")+theme_lz()+theme(axis.text.x = element_text(),legend.position = "")+coord_flip()
```

```{r reenroll_satis.his}
#load historical reenroll_satis.prt
reenroll_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
reenroll.metexpect=c(0.75,0.79,0.74),
reenroll.reenroll=c(0.73,0.78,0.71),
reenroll.alumevent=c(0.67,0.68,0.66))%>%
  pivot_longer(cols=-c(year),names_to="reenroll.",values_to="prt")%>%select(reenroll.,prt,year)
```


```{r viz_reenroll_satis.his}
#set order for showing reenroll. in good order in the historical usage tables
setyorder.reenroll<-ugsatis22.reenroll%>%filter(!is.na(reenroll.value))%>%
  group_by(reenroll.,reenroll.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(reenroll.value=="Yes")%>%arrange(-prt)%>%mutate(yorder=factor(reenroll.))

#merge 2022 reenroll_satis prt
viz_reenroll_satis.his<-ugsatis22.reenroll%>%filter(!is.na(reenroll.value))%>%
  group_by(reenroll.,reenroll.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(reenroll.value=="Yes")%>%mutate(year="2022")%>%
  select(reenroll.,prt,year)%>%
  rbind(reenroll_satis.his)%>%arrange(reenroll.,year,prt)%>%
#viz
  ggplot(aes(y=prt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Overall Engagement",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "")+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=-0.5,hjust=0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(prt,digits = 0)),"")),size=3,vjust=-0.5,hjust=0.5,position = position_dodge(0.9))+
  ylim(0,1.2)+
  
  facet_wrap(~factor(reenroll., levels = setyorder.reenroll$yorder,
                     labels=c("Meet Expectation","Reenroll","Alumni Events")
                     ),
             nrow=1, strip.position="bottom") +
  geom_line(aes(y = prt, x=year, group=reenroll.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```


```{r showviz_overall,fig.height=1.8, include=TRUE}
gridExtra::grid.arrange(viz_overall.hist,viz_reenroll_satis.his, nrow=1)
```

Students' overall experiences and engagement of students have decreased across all items this year. Around 4-10% less students are satisfied in services, have their expectations met, and think they'll reenroll.

Areas that may cause the decrease in overall satisfaction may include problems of infrastructure in the dorm (i.e. broken elevators and dirty/moldy toilets). Another problem a few students mentioned is the incidents of sexual assaults, which made students feel unsafe with the student still around. Title Nine survey in 2021 spring indicated that 62% of students experienced Sexual Misconduct (sexual harassment, stalking, dating violence, or sexual violence) at least once.


# Services Usage and Satisfaction

```{r ugsatis22.service}
#check same answers: lapply(ugsatis22.quan%>%select(starts_with(sec.names$value[2])), unique)

#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.service<-ugsatis22.quan%>%
  select(starts_with(sec.names$value[2]))%>%#check: str()
  pivot_longer(cols=starts_with(sec.names$value[2]),names_to=sec.names$value[2],values_to=paste0(sec.names$value[2],"value"))#check:%>%str()

#recode/remove/factorize
ugsatis22.service<-ugsatis22.service%>%
  #combine values together
  mutate(service.value=if_else(service.value%in%c("Extremely Dissatisfied","Dissatisfied"),"Dissatisfied",
if_else(service.value%in%c("Satisfied","Extremely Satisfied"),"Satisfied","Not Used")),
  #factorize
service.value=factor(service.value,levels=c("Not Used","Dissatisfied","Satisfied")))%>%
  #remove NA
  filter(!is.na(service.value))
```

```{r viz_service_use}
#plotting donut/box/bar using template codes built above

#tbl for usage
viz_service_use<-ugsatis22.service%>%
  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(service.value=="Not Used")%>%mutate(useprt=1-prt)%>%
#viz
ggplot(aes(y=reorder(service.,useprt),x = useprt, fill=service.value)) + 
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
  scale_fill_manual(values = c(color_blue))+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("IC3","Career Center", "Counseling Center","Campus Shuttle","Financial Aid","I.T. Helpdesk","AAC","Student Accounts","Health Center","Registra's Office","Library Database","Mail Service"))+#1st label at bottom
  geom_text(aes(label=percent(useprt,digits = 0)),size=3,vjust=0.5,hjust=1,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    labs(title="Service Usage in 2022 Fall",x="",y="",fill="")+theme_lz()+theme(axis.text.y = element_text(),legend.position = "")
```

```{r viz_service_satis}
#plotting donut/box/bar using template codes built above

#tbl for satisfaction
viz_service_satis<-ugsatis22.service%>%filter(service.value!="Not Used")%>%#filter before prt
  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(service.value=="Satisfied")%>%#only care about satisfaction here
#viz
ggplot(aes(y=reorder(service.,prt), x = prt, fill=service.value)) + 
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+#position = position_stack(),width=0.9
  scale_fill_manual(values = c(color_blue))+#guide = guide_legend(reverse = TRUE)
  scale_y_discrete(labels=c("Campus Shuttle","Financial Aid","Registra's Office","Health Center","Student Accounts","I.T. Helpdesk", "Career Center", "Counseling Center","Mail Service","IC3","Library Database", "AAC"))+#1st label at bottom
  geom_text(aes(label=percent(prt,digits = 0)),size=3,vjust=0.5,hjust=1,fontface="bold",position = position_dodge(0.9))+#position = position_stack(0), vjust=0.5,hjust=0
    labs(title="Service Satisfaction in 2022 Fall",x="",y="",fill="")+theme_lz()+theme(axis.text.y = element_text(),legend.position = "")
```

```{r showviz_service_use}
#decide to hide b/c the historical viz already included 2022 info (both use and satis)
gridExtra::grid.arrange(viz_service_use,viz_service_satis, nrow=1, widths=c(1,1))
```

```{r viz_service_use.hist}
#set order for showing service. in good order in the historical usage tables
setyorder.use<-ugsatis22.service%>%
  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(service.value=="Not Used")%>%arrange(prt)%>%mutate(yorder=factor(service.))

#load historical service_use.prt
service_use.his<-tibble(year=as.character(c(2019,2020,2021)),service.mail=c(0.73,0.80,0.77),
service.reg=c(0.68,0.82,0.71),
service.health=c(0.52,0.67,0.69),
service.libdb=c(0.75,0.79,0.67),
service.stuaccount=c(0.55,0.76,0.61),
service.finaid=c(0.45,0.63,0.56),
service.aac=c(0.45,0.63,0.49),
service.i.t.helpdesk=c(0.56,0.67,0.49),
service.shuttle=c(0.54,0.68,0.48),
service.counsel=c(0.24,0.44,0.33),
service.career=c(0.29,0.46,0.32),
service.ic3=c(0.51,0.44,0.27))%>%
  pivot_longer(cols=c(service.mail:service.ic3),names_to="service.",values_to="useprt")%>%select(service.,useprt,year)

#merge 2022 service_use prt
viz_service_use.hist<-ugsatis22.service%>%
  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(service.value=="Not Used")%>%mutate(useprt=1-prt,year="2022")%>%
  select(service.,useprt,year)%>%
  rbind(service_use.his,by=c())%>%arrange(service.,year,useprt)%>%
#viz
  ggplot(aes(y=useprt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Historical Comparision of Service Usage",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "")+#space between legend and plot is 20
  geom_text(aes(label=if_else( year==2022, as.character(percent(useprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(useprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,0.9)+coord_flip()+
  
  facet_wrap(~factor(service., levels = setyorder.use$yorder,labels=c(
    "Mail Service","Library Database","Registra's Office","Health Center","Student Accounts","AAC","I.T. Helpdesk","Financial Aid","Campus Shuttle","Counseling Center","Career Center","IC3"
  )),
             ncol=1, strip.position="left") +
  geom_line(aes(y = useprt, x=year, group=service.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```

```{r viz_service_satis.hist}
#set order for showing service. in good order in the historical usage tables
#setyorder.satis<-ugsatis22.service%>%filter(service.value!="Not Used")%>%
#  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
#  filter(service.value=="Satisfied")%>%arrange(-prt)%>%mutate(yorder=factor(service.))

#load historical service_satis.prt
service_satis.his<-tibble(year=as.character(c(2019,2020,2021)),service.aac=c(0.95,0.95,0.91),
service.shuttle=c(0.8,0.89,0.94),
service.career=c(0.95,0.93,0.88),
service.counsel=c(0.92,0.93,0.91),
service.health=c(0.87,0.93,0.88),
service.i.t.helpdesk=c(0.87,0.91,0.89),
service.ic3=c(0.97,0.95,0.96),
service.libdb=c(0.95,0.95,0.96),
service.mail=c(0.98,0.98,0.97),
service.stuaccount=c(0.9,0.89,0.87),
service.reg=c(0.88,0.87,0.83),
service.finaid=c(0.89,0.87,0.86))%>%
  pivot_longer(cols=c(service.aac:service.finaid),names_to="service.",values_to="satisprt")%>%select(service.,satisprt,year)

#merge 2022 service_satis prt
viz_service_satis.hist<-ugsatis22.service%>%filter(service.value!="Not Used")%>%
  group_by(service.,service.value)%>%summarise(n=n())%>%mutate(satisprt=n/sum(n))%>%
  filter(service.value=="Satisfied")%>%mutate(year="2022")%>%
  select(service.,satisprt,year)%>%
  rbind(service_satis.his,by=c())%>%arrange(service.,year,satisprt)%>%
#viz
  ggplot(aes(y=satisprt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Historical Comparision of Service Satisfaction",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "right",legend.direction = "vertical",legend.box.margin=margin(20,20,20,20))+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,1.2)+coord_flip()+
  

    facet_wrap(~factor(service., levels = setyorder.use$yorder,labels=c(
    "Mail Service","Library Database","Registra's Office","Health Center","Student Accounts","AAC","I.T. Helpdesk","Financial Aid","Campus Shuttle","Counseling Center","Career Center","IC3"
  )),
             ncol=1, strip.position="left") +
  
  #"AAC","Library Database","IC3","Mail Service",
  #"Counseling Center","Career Center","I.T. Helpdesk",
  #"Student Accounts","Health Center","Registra's Office",
  #"Financial Aid","Campus Shuttle"
  geom_line(aes(y = satisprt, x=year, group=service.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```

```{r showviz_service_hist,fig.height=8,include=TRUE}
#arrange named plots (include=TRUE, default fig.height or 3)
gridExtra::grid.arrange(viz_service_use.hist,viz_service_satis.hist, nrow=1, widths=c(1,1))
```

Satisfaction and usage in shuttle both decreased over 10%, compared to 2021. Students indicated that the shuttle's schedule and stops are sometimes unclear/inaccurate. A few students pointed out shuttle being late, lack late-time availability, and do not stop at places that students need to go. 

Satisfaction in Financial Aid service dropped 5%. Students indicated that the process of paying is hard to navigate and errors around financial aid occurs. A few students mentioned unclear information and slow communication from the office. Several students concerned in losing scholarships and not having tuition reduction applied to them. A few students suggested to have more knowledgeable and empathetic staff communicating with them.

 

# Satisfaction in Academic Life, Community, and Resources

```{r names_acagrp}
names_acagrp<-c("crs.majorquality",
"community.registerclass",
"crs.instructquality",
"crs.gequality",
"crs.variety",
"community.fewclassconflict",
"community.facultyavailable",
"crs.facultyknow",
"support.facultyresponsive",
"community.facultycare",
"support.facultyfeedback",
"support.facultydiverse",
"support.acaneeds",
"advisor.communicate",
"advisor.knowmajor",
"advisor.setgoal")
#check: names_aca[!names_aca%in%names(ugsatis22.quan)]
```

```{r ugsatis22.acagrp}
#check same answers: lapply(ugsatis22.quan[names(ugsatis22.quan)%in%names_acagrp], unique)

#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.acagrp<-ugsatis22.quan[names(ugsatis22.quan)%in%names_acagrp]%>%
  pivot_longer(cols=all_of(names_acagrp),names_to="acagrp.",values_to="acagrp.value")#check:%>%str(); ugsatis22.acagrp%>%count(acagrp); ugsatis22.acagrp%>%count(acagrp.value)

#recode/remove/factorize
ugsatis22.acagrp<-ugsatis22.acagrp%>%
  #combine values together
  mutate(acagrp.value=case_when(
acagrp.value%in%c("Strongly Disagree","Disagree")~"Dissatisfied",
acagrp.value%in%c("Agree","Strongly Agree")~"Satisfied"),
  #factorize
         acagrp.value=factor(acagrp.value,levels=c("Dissatisfied","Satisfied")))%>%
  #remove NA
  filter(!is.na(acagrp.value))#check:%>%count(acagrp.value)
```

```{r viz_acagrp_satis.his}
#set order for showing acagrp. in good order in the historical usage tables
setyorder.acagrp<-ugsatis22.acagrp%>%
  group_by(acagrp.,acagrp.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(acagrp.value=="Satisfied")%>%arrange(-prt)%>%mutate(yorder=factor(acagrp.))

#load historical acagrp_satis.prt
acagrp_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
crs.majorquality=c(0.93,0.88,0.88),
community.registerclass=c(NA,0.82,0.81),
crs.instructquality=c(0.94,0.86,0.85),
crs.gequality=c(0.88,0.89,0.84),
crs.variety=c(0.94,0.83,0.81),
community.fewclassconflict=c(0.76,0.78,0.76),
community.facultyavailable=c(0.97,0.95,0.94),
crs.facultyknow=c(0.94,0.94,0.91),
support.facultyresponsive=c(0.97,0.9,0.89),
community.facultycare=c(0.89,0.88,0.89),
support.facultyfeedback=c(0.88,0.87,0.86),
support.facultydiverse=c(0.91,0.84,0.78),
support.acaneeds=c(0.98,0.95,0.95),
advisor.communicate=c(0.90,0.9,0.89),
advisor.knowmajor=c(0.89,0.91,0.89),
advisor.setgoal=c(0.86,0.88,0.85))%>%
  pivot_longer(cols=-c(year),names_to="acagrp.",values_to="satisprt")%>%select(acagrp.,satisprt,year)

#merge 2022 acagrp_satis prt
viz_acagrp_satis.his<-ugsatis22.acagrp%>%
  group_by(acagrp.,acagrp.value)%>%summarise(n=n())%>%mutate(satisprt=n/sum(n))%>%
  filter(acagrp.value=="Satisfied")%>%mutate(year="2022")%>%
  select(acagrp.,satisprt,year)%>%
  rbind(acagrp_satis.his)%>%arrange(acagrp.,year,satisprt)%>%
#viz
  ggplot(aes(y=satisprt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Course, Faculty, and Advising",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "",legend.box.margin=margin(20,20,20,20))+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,1.3)+coord_flip()+
  
  facet_wrap(~factor(acagrp., levels = setyorder.acagrp$yorder,labels=c("Faculty availability","Faculty knowledge","Faculty responsive","Faculty care","Advisor communicate","Support needs", "Instruction quality","Major quality","Advisor knowledge","GE quality","Register class","Advisor set goal","Faculty diverse","Faculty feedback","Course variety","Class conflict")),
             ncol=1, strip.position="left") +
  geom_line(aes(y = satisprt, x=year, group=acagrp.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```



```{r names_socgrp}
names_socgrp<-c("community.diverseindiv",
"community.schoolspirit",
"community.acacommit",
"community.acaintegrity",
"social.pride",
"community.partof",
"community.voiceheard",
"social.athletics",
"social.selectact",
"social.knowact",
"social.enjoycampuswkend",
"social.weekendact")
#check: names_socgrp[!names_socgrp%in%names(ugsatis22.quan)]
```

```{r ugsatis22.socgrp}
#check same answers: lapply(ugsatis22.quan[names(ugsatis22.quan)%in%names_socgrp], unique)

#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.socgrp<-ugsatis22.quan[names(ugsatis22.quan)%in%names_socgrp]%>%
  pivot_longer(cols=all_of(names_socgrp),names_to="socgrp.",values_to="socgrp.value")#check:%>%str(); ugsatis22.socgrp%>%count(socgrp); ugsatis22.socgrp%>%count(socgrp.value)

#recode/remove/factorize
ugsatis22.socgrp<-ugsatis22.socgrp%>%
  #combine values together
  mutate(socgrp.value=case_when(
socgrp.value%in%c("Strongly Disagree","Disagree")~"Dissatisfied",
socgrp.value%in%c("Agree","Strongly Agree")~"Satisfied"),
  #factorize
         socgrp.value=factor(socgrp.value,levels=c("Dissatisfied","Satisfied")))%>%
  #remove NA
  filter(!is.na(socgrp.value))#check:%>%count(socgrp.value)
```

```{r viz_socgrp_satis.his}
#set order for showing socgrp. in good order in the historical usage tables
setyorder.socgrp<-ugsatis22.socgrp%>%
  group_by(socgrp.,socgrp.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(socgrp.value=="Satisfied")%>%arrange(-prt)%>%mutate(yorder=factor(socgrp.))

#load historical socgrp_satis.prt
socgrp_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
community.diverseindiv=c(0.91,0.92,0.93),
community.schoolspirit=c(0.69,0.74,0.66),
community.acacommit=c(0.90,0.92,0.91),
community.acaintegrity=c(0.89,0.93,0.88),
social.pride=c(0.83,0.84,0.75),
community.partof=c(0.76,0.75,0.75),
community.voiceheard=c(0.80,0.76,0.73),
social.athletics=c(0.83,0.79,0.81),
social.selectact=c(0.81,0.79,0.81),
social.knowact=c(0.81,0.74,0.73),
social.enjoycampuswkend=c(0.59,0.56,0.60),
social.weekendact=c(0.54,0.43,0.47))%>%
  pivot_longer(cols=-c(year),names_to="socgrp.",values_to="satisprt")%>%select(socgrp.,satisprt,year)

#merge 2022 socgrp_satis prt
viz_socgrp_satis.his<-ugsatis22.socgrp%>%
  group_by(socgrp.,socgrp.value)%>%summarise(n=n())%>%mutate(satisprt=n/sum(n))%>%
  filter(socgrp.value=="Satisfied")%>%mutate(year="2022")%>%
  select(socgrp.,satisprt,year)%>%
  rbind(socgrp_satis.his)%>%arrange(socgrp.,year,satisprt)%>%
#viz
  ggplot(aes(y=satisprt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Community and Activity",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "bottom")+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,1.3)+coord_flip()+
  
  facet_wrap(~factor(socgrp., levels = setyorder.socgrp$yorder, labels=c("Diverse community","Academic commitment","Academic integrity","Athletics activity","Activity variety","Sense of belonging","Lasell pride","Know activity","Voice heard","School spirit","Enjoy campus weekend","Weekend activity")
                     ),
             ncol=1, strip.position="left") +
  geom_line(aes(y = satisprt, x=year, group=socgrp.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```

```{r names_resgrp}
names_resgrp<-c("crs.prgcareer",
"support.opportunities",
"crs.connectedlearning",
"community.worthtuition",
"support.police",
"support.computerlabs",
"support.campusmaintain",
"food.availability",
"community.residcomfort",
"food.select",
"food.quality")
#check: names_resgrp[!names_resgrp%in%names(ugsatis22.quan)]
```

```{r ugsatis22.resgrp}
#check same answers: lapply(ugsatis22.quan[names(ugsatis22.quan)%in%names_resgrp], unique)

#mutate same 4answer questions as two var: one represent the 4categories, the other represent the answer for the category
ugsatis22.resgrp<-ugsatis22.quan[names(ugsatis22.quan)%in%names_resgrp]%>%
  pivot_longer(cols=all_of(names_resgrp),names_to="resgrp.",values_to="resgrp.value")#check:%>%str(); ugsatis22.resgrp%>%count(resgrp.); ugsatis22.resgrp%>%count(resgrp.value)

#recode/remove/factorize
ugsatis22.resgrp<-ugsatis22.resgrp%>%
  #combine values together
  mutate(resgrp.value=case_when(
resgrp.value%in%c("Strongly Disagree","Disagree")~"Dissatisfied",
resgrp.value%in%c("Agree","Strongly Agree")~"Satisfied"),
  #factorize
         resgrp.value=factor(resgrp.value,levels=c("Dissatisfied","Satisfied")))%>%
  #remove NA
  filter(!is.na(resgrp.value))#check:%>%count(resgrp.value)
```

```{r viz_resgrp_satis.his}
#set order for showing resgrp. in good order in the historical usage tables
setyorder.resgrp<-ugsatis22.resgrp%>%
  group_by(resgrp.,resgrp.value)%>%summarise(n=n())%>%mutate(prt=n/sum(n))%>%
  filter(resgrp.value=="Satisfied")%>%arrange(-prt)%>%mutate(yorder=factor(resgrp.))

#load historical resgrp_satis.prt
resgrp_satis.his<-tibble(year=as.character(c(2019,2020,2021)),
crs.prgcareer=c(0.93,0.94,0.92),
support.opportunities=c(0.94,0.88,0.87),
crs.connectedlearning=c(0.96,0.88,0.84),
community.worthtuition=c(0.73,0.73,0.68),
support.police=c(0.90,0.91,0.91),
support.computerlabs=c(0.91,0.94,0.91),
support.campusmaintain=c(0.94,0.95,0.87),
food.availability=c(0.86,0.72,0.72),
community.residcomfort=c(0.83,0.86,0.68),
food.select=c(0.5,0.44,0.47),
food.quality=c(0.39,0.43,0.46))%>%
  pivot_longer(cols=-c(year),names_to="resgrp.",values_to="satisprt")%>%select(resgrp.,satisprt,year)

#merge 2022 resgrp_satis prt
viz_resgrp_satis.his<-ugsatis22.resgrp%>%
  group_by(resgrp.,resgrp.value)%>%summarise(n=n())%>%mutate(satisprt=n/sum(n))%>%
  filter(resgrp.value=="Satisfied")%>%mutate(year="2022")%>%
  select(resgrp.,satisprt,year)%>%
  rbind(resgrp_satis.his)%>%arrange(resgrp.,year,satisprt)%>%
#viz
  ggplot(aes(y=satisprt, x=year, fill=year ))+
  geom_bar(stat="identity",position = position_dodge(),width=0.9)+
  scale_fill_manual(values =c("grey90","grey80","grey70",color_blue),guide = guide_legend(reverse = TRUE))+
  labs(title="Resources",x="",y="",fill="") + theme_lz()+
  theme(legend.position = "")+#space between legend and plot is 10, then move down 30
  geom_text(aes(label=if_else( year==2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,fontface="bold",position = position_dodge(0.9))+
  geom_text(aes(label=if_else( year!=2022, as.character(percent(satisprt,digits = 0)),"")),size=3,vjust=.5,hjust=-0.5,position = position_dodge(0.9))+
  ylim(0,1.3)+coord_flip()+
  
  facet_wrap(~factor(resgrp., levels = setyorder.resgrp$yorder,
                     labels=c("Computer labs","Career prep","Connected learning","Campus police","Campus maintainance","Intern oppotunity","Residential comfort","Worth tuition","Food availability","Food quality","Food selection")),
             ncol=1, strip.position="left") +
  geom_line(aes(y = satisprt, x=year, group=resgrp.), 
                color="grey50", linetype="dashed",stat="identity", show.legend = F)
```



```{r show.viz_acagrp_satis.his,fig.height=9,include=TRUE}
gridExtra::grid.arrange(viz_acagrp_satis.his,viz_socgrp_satis.his,viz_resgrp_satis.his, nrow=1, widths=c(1,1,1))
```

Satisfaction in faculty feedback decreased 8%. Many students indicated their professors do not grade assignments timely and respond to their emails. Several students also mentioned that they do not feel professor accommodate students with special needs (i.e. working, second-language, disability) and consider diverse students experiences in class. Several students also mentioned that they feel course, especially core courses, are not structured or organized. Some students indicated that their teachers seem to be unprepared and inexperienced to teach the topic.

Course variety received around 4% less satisfaction. Several students mentioned they hope to have more in-person courses. Many students indicated that there is insufficient course offered or have conflict to select the course they want. A few students also indicated a stressful course registration process with not enough course to register. Some students thus worried about graduating on time due to course unavailability.

Satisfaction in the dining services has been low. This year satisfaction in food availability further dropped 7% and food selection dropped 4%. Food poisoning (including not fully cooked, reuse of food, reports of cockroaches being found) is a problem mentioned by multiple students. Many students also indicated food running out, limited/repetitive option, unhealthy, and lack of late-hour availability (e.g. 1851 late dinner no longer available). Additionally, many students feel disappointed because they do not feel their voice heard due to the unchanged situation in the dining hall. 



# Group Difference Regression

```{r load.ugsatis22.recoded}
ugsatis22.recoded<-read_excel("/Volumes/lasellshare/Faculty_Staff_Shares$/IR/Surveys/Lasell Internal/Student Satisfaction Survey/2022-2023/ugsatis22.recoded.xlsx")
#names(ugsatis22.recoded)

#outcome vars: sum.service,sum.aca,sum.soc,sum.res

#predictor vars: ethnicity, demography.gender, fa_pell_eligible_yn, parents_attended_coll, hs_gpa, academic_dept, class_level, transfer_yn, rescom

##check: lapply(ugsatis22.recoded[,c("ethnicity", "gender","demography.gender", "fa_pell_eligible_yn", "parents_attended_coll", "hs_gpa", "academic_dept", "class_level", "transfer_yn", "resident_yn"], unique)
```

```{r}
#select(starts_with("service."),names_acagrp,names_socgrp,names_resgrp)
```

```{r recodedf}
#clean
##gender-basic clean
recodedf<-ugsatis22.recoded%>%
  mutate(gender=recode(gender,`M`="Male",`F`="Female"),
         demography.gender=recode(demography.gender,
`Prefer not to say`="Non-Binary",
`Prefer to self-describe (Please specify):`="Non-Binary",
`Trans/Non-Binary`="Non-Binary"),
         genderbinary=if_else(demography.gender=="Non-Binary","Nonbinary","Binary"),
         genderbinary=if_else(is.na(genderbinary),"Binary",genderbinary),
         genderbinary=factor(genderbinary,levels=c("Binary","Nonbinary")),
         gender=factor(gender,levels=c("Male","Female")),

         transfer_yn=recode(transfer_yn,`N`="Not-transfer",`Y`="transfer"),
         transfer_yn=factor(transfer_yn,levels=c("Not-transfer","transfer")),

         parents_attended_coll=case_when(parents_attended_coll=="Y"~"Not 1st-Gen",
                                       parents_attended_coll=="N"~"1st-Gen"),
         parents_attended_coll=factor(parents_attended_coll,
                                      levels=c("Not 1st-Gen","1st-Gen")),

         fa_pell_eligible_yn=recode(fa_pell_eligible_yn,`0`="Not pell",`1`="Pell"),
         fa_pell_eligible_yn=factor(fa_pell_eligible_yn,levels=c("Not pell","Pell")),

         class_level=recode(class_level,`SR`="4th-year",`SO`="2nd-year",`FR`="1st-year",`JR`="3rd-year"),
         resident_yn=recode(resident_yn,`1`="Resident",`0`="Commuter"),
         resident_yn=factor(resident_yn,levels=c("Commuter","Resident")),

         ethnicity=recode(ethnicity,`Black or African American`="Black",`Two or more Races`="Multi-races",`Race and Ethnicity Unknown`="Unknown",`Non Resident Alien`="International",`Native Hawaiian or Other Pacific Islander`="Native"),
         ethnicity=factor(ethnicity,levels=c("White","Black","Asian","Hispanic","Multi-races","Unknown","International","Native")),
         
         academic_dept=tolower(academic_dept),
         academic_dept=recode(academic_dept,`update`="undeclared, general"),
         school=case_when(
academic_dept%in%c("art and graphic design", "communication")~"Communication",
academic_dept%in%c("fashion")~"Fashion",
academic_dept%in%c("social sciences", "justice studies", "humanities", "education")~"HEJSS",
academic_dept%in%c( "athletic training/exercise science")~"Health Science",
academic_dept%in%c("sport management", "marketing/management", "business and information science", "accounting/finance")~"Business",
academic_dept=="undeclared, general"~"undeclared"),
school=factor(school,levels=c("undeclared","Business","HEJSS","Communication","Fashion","Health Science")))

#check: recodedf%>%count(school,academic_dept);recodedf%>%count(school,academic_dept)%>%arrange(-n);recodedf%>%count(genderbinary,gender,demography.gender)
predictvars<-c("ethnicity", "genderbinary","gender", "fa_pell_eligible_yn", "parents_attended_coll", "hs_gpa", "school", "class_level", "transfer_yn", "resident_yn")
#check: lapply(recodedf[,predictvars], unique); lapply(recodedf[,predictvars], str)
```

```{r featurePlot-hide}
featurePlot(x=recodedf[,predictvars],y=recodedf$sum.service,plot="pairs")#hs_gpa=0 and not 0 are 2 groups
nearZeroVar(recodedf[,predictvars],saveMetrics=T)
```

## Group Differences for Satisfaction in Service

Services satisfaction increased for the following groups of students. Pell eligible students have 1.3 more satisfied services than non pell eligible students. Transfer students have 1.5 more satisfied service than non-transfer students. Residents have 0.8 more satisfied services than commuters. Also, for each unit GPA increase, students could have 0.5 more satisfied service.

However, services satisfaction decreased for students at School of Communication and Fashion, as they both have around 1 less satisfied services than students who haven't declared their major.

```{r select_mod.service}
mod.servicefull<-lm(sum.service~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)
mod.servicefull<-lm(sum.service~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=na.omit(recodedf[,all.vars(formula(mod.servicefull))]))
mod.service0<-lm(sum.service~1,data=na.omit(recodedf[,all.vars(formula(mod.servicefull))]))

#fmod <- MASS::stepAIC(object = mod.service0, direction = "forward", scope = formula(mod.servicefull), trace=FALSE);coef(fmod);fmod$anova
#bmod <- MASS::stepAIC(object = mod.servicefull, direction = "backward", scope = formula(mod.service0), trace=FALSE);coef(bmod);bmod$anova
smod <- MASS::stepAIC(mod.servicefull, direction = "both", trace=FALSE);coef(smod);smod$anova#all 10 vars included
```

```{r summary_mod.service}
#final model
mod.service<-lm(sum.service~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)
#see hilighted vars
summary(mod.service)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars

##Services satisfaction differs for ethnicity groups. Compared to White students, multi-racial students have 3 more satisfied services. International students have 1.7 more satisfied services than White students. However, Asian students have 0.8 less satisfied services than White students. 

##Services satisfaction increase for the following groups of students. Pell eligible students have 1.3 more satisfied services than non pell eligible students. For each unit GPA increase, students could have 0.5 more satisfied service. Transfer students have 1.2 more satisfied service than non-transfer students. Residents have 0.8 more satisfied services than commuters.

##However, services satisfaction decreased for the following Lasell schools, compared to students who have not declare majors. Students at School of Communication, Health science, Fashion all have decreased satisfied services by 1.1, 0.9, and 0.8 item respectively.
```

```{r hide-stepbystep.anova_service}
mod.service1<-lm(sum.service~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)

mod.service2 <- update(mod.service1, .~.-ethnicity, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service3 <- update(mod.service1, .~.-genderbinary, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service4 <- update(mod.service1, .~.-gender, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service5 <- update(mod.service1, .~.-fa_pell_eligible_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service6 <- update(mod.service1, .~.-parents_attended_coll, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service7 <- update(mod.service1, .~.-hs_gpa, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service8 <- update(mod.service1, .~.-school, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service9 <- update(mod.service1, .~.-class_level,
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service10 <- update(mod.service1, .~.-transfer_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))
mod.service11 <- update(mod.service1, .~.-resident_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.service1))]))

#depends on the order of adding, it influences the others sig: anova(mod1,mod2,mod3,mod4,mod5,mod6,mod7,mod8,mod9,mod10) #check: anova(mod1,mod2,mod3,mod7,mod8)
#need to test each vars sig one by one
anova(mod.service1,mod.service2)
anova(mod.service1,mod.service3)
anova(mod.service1,mod.service4)#gender has less sig
anova(mod.service1,mod.service5)
anova(mod.service1,mod.service6)
anova(mod.service1,mod.service7)
anova(mod.service1,mod.service8)
anova(mod.service1,mod.service9)#class level has less sig
anova(mod.service1,mod.service10)
anova(mod.service1,mod.service11)
#can explain why, although gender, genderbinary, and classlevel are included in the final model using the MASS:stepAIC approach, their coefficients are not sig as estimates
#final model
mod.service_try<-lm(sum.service~ethnicity+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+transfer_yn+resident_yn,data=recodedf)
#see hilighted vars
summary(mod.service_try)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.01)%>%select(Estimate)#select ** vars
```

```{r service_white-mulrace-hideduetoN}
#statement from regression: Compared to White students, multi-racial students usually have 3.2 more satisfied services.
#however, the N of ASIAN, MULTIRACES, INTERNATIONAL all below 30, should exclude out of analysis
```

### Pell Eligible Students: More Satisfied Financial Aid & IC3

```{r service_pell.difftbl}
#check: recodedf%>%count(fa_pell_eligible_yn)
recodedf%>%group_by(fa_pell_eligible_yn)%>%summarise(mean=mean(sum.service))#the diff between pell is 5 out of 12 vs nonpell is 6 out of 12; #recodedf%>%select(starts_with(prefix))%>%ncol()#all 12 item

#create a tbl of the difference b/w white vs multiraces across all services
prefix<-"service."
service_pell.difftbl<-recodedf%>%select(starts_with(prefix),fa_pell_eligible_yn,ppid)%>%
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))%>%#cols=all_of(names_sec)
  unique()%>%#need to add ppid and this unique to deduplicate!!!
  filter(!is.na(service.value))%>%
  group_by(service.,fa_pell_eligible_yn,service.value)%>%count()%>%
  ungroup()%>%group_by(service.,fa_pell_eligible_yn)%>%
  mutate(prt=percent(n/sum(n),digit=0))%>%filter(service.value==1)%>%
  #filter(fa_pell_eligible_yn%in%c("White","Multi-races"))%>%#add when compare specific group values
  select(service.,fa_pell_eligible_yn,prt)%>%
  pivot_wider(names_from=fa_pell_eligible_yn,values_from=prt)%>%
  mutate(diff=Pell-`Not pell`)%>%filter(abs(diff)>.2)
```

```{r show.kbl_service_pell.difftbl, include=TRUE}
service_pell.difftbl%>%#format table as viz
kbl(align = "c", booktabs = T,
    col.names =c("",str_wrap(names(service_pell.difftbl)[2:ncol(service_pell.difftbl)],width = 5))) %>%
kable_styling(latex_options = c('HOLD_position'), full_width = F, fixed_thead = T, font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
column_spec(1, bold = T, border_right = F, background = "white", width = "5em",color="black")
```

### Transfer Students: More Satisfied Student Account, but Less Satisfied Mail

```{r service_trans.difftbl}
#check: recodedf%>%names()
recodedf%>%group_by(transfer_yn)%>%summarise(mean=mean(sum.service))#same #recodedf%>%select(starts_with(prefix))%>%ncol()#all 12 item

#create a tbl of the difference b/w white vs multiraces across all services
prefix<-"service."
service_trans.difftbl<-recodedf%>%select(starts_with(prefix),transfer_yn)%>%
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))%>%#cols=all_of(names_sec)
  filter(!is.na(service.value))%>%
  group_by(service.,transfer_yn,service.value)%>%count()%>%
  ungroup()%>%group_by(service.,transfer_yn)%>%
  mutate(prt=percent(n/sum(n),digit=0))%>%filter(service.value==1)%>%
  #filter(transfer_yn%in%c("White","Multi-races"))%>%#add when compare specific group values
  select(service.,transfer_yn,prt)%>%
  pivot_wider(names_from=transfer_yn,values_from=prt)%>%
  mutate(diff=transfer-`Not-transfer`)%>%filter(abs(diff)>.18)
```

```{r show.kbl_service_trans.difftbl, include=TRUE}
service_trans.difftbl%>%#format table as viz
kbl(align = "c", booktabs = T,
    col.names =c("",str_wrap(names(service_trans.difftbl)[2:ncol(service_trans.difftbl)],width = 5))) %>%
kable_styling(latex_options = c('HOLD_position'), full_width = F, fixed_thead = T, font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
column_spec(1, bold = T, border_right = F, background = "white", width = "5em",color="black")
```

### Residents: More Satisfied Health & Mail
```{r service_resid.difftbl}
#check: recodedf%>%names()
recodedf%>%group_by(resident_yn)%>%summarise(mean=mean(sum.service))#res 5.7 com 5 #recodedf%>%select(starts_with(prefix))%>%ncol()#all 12 item

#create a tbl of the difference b/w white vs multiraces across all services
prefix<-"service."
service_resid.difftbl<-recodedf%>%select(starts_with(prefix),resident_yn)%>%
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))%>%#cols=all_of(names_sec)
  filter(!is.na(service.value))%>%
  group_by(service.,resident_yn,service.value)%>%count()%>%
  ungroup()%>%group_by(service.,resident_yn)%>%
  mutate(prt=percent(n/sum(n),digit=0))%>%filter(service.value==1)%>%
  #filter(resident_yn%in%c("White","Multi-races"))%>%#add when compare specific group values
  select(service.,resident_yn,prt)%>%
  pivot_wider(names_from=resident_yn,values_from=prt)%>%
  mutate(diff=Resident-Commuter)%>%filter(abs(diff)>.18)
```

```{r show.kbl_service_resid.difftbl, include=TRUE}
service_resid.difftbl%>%#format table as viz
kbl(align = "c", booktabs = T,
    col.names =c("",str_wrap(names(service_resid.difftbl)[2:ncol(service_resid.difftbl)],width = 5))) %>%
kable_styling(latex_options = c('HOLD_position'), full_width = F, fixed_thead = T, font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
column_spec(1, bold = T, border_right = F, background = "white", width = "5em",color="black")
```

### High School GPA: later to plot service together with aca,soc,res

### Communication and Fashion School: Less Satisfied AAC & Library
```{r service_school.difftbl}
#check: recodedf%>%names()
recodedf%>%group_by(school)%>%summarise(mean=mean(sum.service))#5.52undelcared,4.7com,5.3fashion #recodedf%>%select(starts_with(prefix))%>%ncol()#all 12 item

#create a tbl of the difference b/w white vs multiraces across all services
prefix<-"service."
service_school.difftbl<-recodedf%>%select(starts_with(prefix),school)%>%
  pivot_longer(cols=starts_with(prefix),names_to=prefix,values_to=paste0(prefix,"value"))%>%#cols=all_of(names_sec)
  filter(!is.na(service.value))%>%
  group_by(service.,school,service.value)%>%count()%>%
  ungroup()%>%group_by(service.,school)%>%
  mutate(prt=percent(n/sum(n),digit=0))%>%filter(service.value==1)%>%
  filter(school%in%c("Communication","Fashion","undeclared"))%>%#add when compare specific group values
  select(service.,school,prt)%>%
  pivot_wider(names_from=school,values_from=prt)%>%
  mutate(Com_diff=Communication-undeclared,
         Fash_diff=Fashion-undeclared)%>%
  filter(abs(Com_diff)>.18 | abs(Fash_diff)>.18)
```

```{r show.kbl_service_school.difftbl, include=TRUE}
service_school.difftbl%>%#format table as viz
kbl(align = "c", booktabs = T,
    col.names =c("",str_wrap(names(service_school.difftbl)[2:ncol(service_school.difftbl)],width = 5))) %>%
kable_styling(latex_options = c('HOLD_position'), full_width = F, fixed_thead = T, font_size = 12, bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
column_spec(1, bold = T, border_right = F, background = "white", width = "5em",color="black")
```





## Group Differences for Satisfaction in Academic Life

```{r select_mod.aca}
mod.acafull<-lm(sum.aca~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)
mod.acafull<-lm(sum.aca~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=na.omit(recodedf[,all.vars(formula(mod.acafull))]))
mod.aca0<-lm(sum.aca~1,data=na.omit(recodedf[,all.vars(formula(mod.acafull))]))

#fmod <- MASS::stepAIC(object = mod.aca0, direction = "forward", scope = formula(mod.acafull), trace=FALSE);coef(fmod);fmod$anova
#bmod <- MASS::stepAIC(object = mod.acafull, direction = "backward", scope = formula(mod.aca0), trace=FALSE);coef(bmod);bmod$anova
smod <- MASS::stepAIC(mod.acafull, direction = "both", trace=FALSE);coef(smod);smod$anova#all 10 vars included
```

```{r summary_mod.aca}
#final model
mod.aca<-lm(sum.aca~ethnicity + gender + parents_attended_coll + hs_gpa + 
    class_level + transfer_yn + resident_yn,data=recodedf)
#see hilighted vars in final model
summary(mod.aca)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
#check: summary(mod.acafull)$coefficients%>%data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
```

```{r hide-stepbystep.anova_aca}
mod.aca1<-lm(sum.aca~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)

mod.aca2 <- update(mod.aca1, .~.-ethnicity, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca3 <- update(mod.aca1, .~.-genderbinary, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca4 <- update(mod.aca1, .~.-gender, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca5 <- update(mod.aca1, .~.-fa_pell_eligible_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca6 <- update(mod.aca1, .~.-parents_attended_coll, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca7 <- update(mod.aca1, .~.-hs_gpa, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca8 <- update(mod.aca1, .~.-school, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca9 <- update(mod.aca1, .~.-class_level,
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca10 <- update(mod.aca1, .~.-transfer_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))
mod.aca11 <- update(mod.aca1, .~.-resident_yn, 
               data=na.omit(recodedf[,all.vars(formula(mod.aca1))]))

#depends on the order of adding, it influences the others sig: anova(mod1,mod2,mod3,mod4,mod5,mod6,mod7,mod8,mod9,mod10) #check: anova(mod1,mod2,mod3,mod7,mod8)
#need to test each vars sig one by one
anova(mod.aca1,mod.aca2)#no sig
anova(mod.aca1,mod.aca3)#no sig
anova(mod.aca1,mod.aca4)#some sig
anova(mod.aca1,mod.aca5)#no sig
anova(mod.aca1,mod.aca6)#mod sig
anova(mod.aca1,mod.aca7)#mod sig
anova(mod.aca1,mod.aca8)#no sig
anova(mod.aca1,mod.aca9)
anova(mod.aca1,mod.aca10)#some sig
anova(mod.aca1,mod.aca11)
#can explain why, although gender, genderbinary, and classlevel are included in the final model using the MASS:stepAIC approach, their coefficients are not sig as estimates
#final model
mod.aca_try<-lm(sum.aca~class_level+resident_yn,data=recodedf)
#see hilighted vars
summary(mod.aca_try)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.01)%>%select(Estimate)#select ** vars
```

```{r aca_pell.difftbl}
#check: recodedf%>%count(fa_pell_eligible_yn)
recodedf%>%group_by(fa_pell_eligible_yn)%>%summarise(mean=mean(sum.aca))# #recodedf%>%select(names_acagrp)%>%ncol()#all  item

#create a tbl of the difference across all services
prefix<-"service."#for naming vars later
aca_pell.difftbl<-recodedf%>%select(names_acagrp,fa_pell_eligible_yn)%>%
  pivot_longer(cols=all_of(names_acagrp),names_to=prefix,values_to=paste0(prefix,"value"))%>%
  filter(!is.na(service.value))%>%
  group_by(service.,fa_pell_eligible_yn,service.value)%>%count()%>%
  ungroup()%>%group_by(service.,fa_pell_eligible_yn)%>%
  mutate(prt=percent(n/sum(n),digit=0))%>%filter(service.value==1)%>%
  #filter(fa_pell_eligible_yn%in%c("White","Multi-races"))%>%#add this line if not all group values are compared
  select(service.,fa_pell_eligible_yn,prt)%>%
  pivot_wider(names_from=fa_pell_eligible_yn,values_from=prt)%>%
  mutate(diff=Pell-`Not pell`)%>%filter(abs(diff)>.07)
```

Residents have 2 less satisfied academic items than commuters. 

## Group Differences for Satisfaction in Social Life

```{r select_mod.soc}
mod.socfull<-lm(sum.soc~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)
mod.socfull<-lm(sum.soc~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=na.omit(recodedf[,all.vars(formula(mod.socfull))]))
mod.soc0<-lm(sum.soc~1,data=na.omit(recodedf[,all.vars(formula(mod.socfull))]))

#fmod <- MASS::stepAIC(object = mod.soc0, direction = "forward", scope = formula(mod.socfull), trace=FALSE);coef(fmod);fmod$anova
#bmod <- MASS::stepAIC(object = mod.socfull, direction = "backward", scope = formula(mod.soc0), trace=FALSE);coef(bmod);bmod$anova
smod <- MASS::stepAIC(mod.socfull, direction = "both", trace=FALSE);coef(smod);smod$anova#all 10 vars included
```

```{r summary_mod.soc}
#final model
mod.soc<-lm(sum.soc~ethnicity + gender + parents_attended_coll + hs_gpa + 
    school + class_level + transfer_yn + resident_yn,data=recodedf)
#see hilighted vars in final model
summary(mod.soc)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
#check: summary(mod.socfull)$coefficients%>%data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
```

First-generation students have 1 more satisfied social items than non first-generation students. For each unit increase of High school GPA, students have 0.6 more satisfied social items. School of Health Science students have 1.9 more satisfied social items than students who havn't declared majors. 

However, Black students have 2 less satisfied social items than White students. Junior students have 1.6 less satisfied social items than Freshmen. Residents have 0.8 less satisfied social items than commuters.

## Group Differences for Satisfaction in Resources

```{r select_mod.res}
mod.resfull<-lm(sum.res~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=recodedf)
mod.resfull<-lm(sum.res~ethnicity+genderbinary+gender+fa_pell_eligible_yn+parents_attended_coll+hs_gpa+ school+class_level+transfer_yn+resident_yn,data=na.omit(recodedf[,all.vars(formula(mod.resfull))]))
mod.res0<-lm(sum.res~1,data=na.omit(recodedf[,all.vars(formula(mod.resfull))]))

#fmod <- MASS::stepAIC(object = mod.res0, direction = "forward", scope = formula(mod.resfull), trace=FALSE);coef(fmod);fmod$anova
#bmod <- MASS::stepAIC(object = mod.resfull, direction = "backward", scope = formula(mod.res0), trace=FALSE);coef(bmod);bmod$anova
smod <- MASS::stepAIC(mod.resfull, direction = "both", trace=FALSE);coef(smod);smod$anova#all 10 vars included
```

```{r summary_mod.res}
#final model
mod.res<-lm(sum.res~ethnicity + gender + parents_attended_coll + hs_gpa + 
    school + class_level + resident_yn,data=recodedf)
#see hilighted vars in final model
summary(mod.res)$coefficients%>%
  data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
#check: summary(mod.resfull)$coefficients%>%data.frame()%>%filter(`Pr...t..`<0.001)%>%select(Estimate)#select ** vars
```

For each unit of high school GPA increase, students have 0.8 more satisfied resources. However, Black and Asian students have around 1.5 less satisfied resources than White students.
